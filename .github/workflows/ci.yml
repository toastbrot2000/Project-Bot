name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Avoid redundant builds on the same PR when you push new commits quickly
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. Setup job to install dependencies once and share them
  install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile

  # 2. Fast checks (Lint & Audit)
  static-analysis:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - run: pnpm run audit

  # 3. Logic checks (Unit) - only run if lint passes
  test-unit:
    needs: static-analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # IMPORTANT: Fetches all history so pnpm can compare against origin/main
      - run: git fetch origin main # Ensures origin/main exists for comparison
      - uses: pnpm/action-setup@v3
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - run: pnpm install --frozen-lockfile
      # Now this will actually work
      - run: pnpm test:affected

  # 4. Heavy checks (E2E) - only run if Unit passes
  test-e2e:
    needs: test-unit
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - name: Build Strapi Backend
        run: pnpm --filter @project-bot/backend build
      - name: Install Playwright Browsers
        run: pnpm --filter e2e-tests exec playwright install --with-deps
      - name: Run Playwright tests
        run: pnpm test:e2e
